<!-- Header -->
<div class="profile-header"
     [style.background-image]="capaUrl ? 'url(' + capaUrl + ')' : 'none'"
     [style.background-size]="'cover'"
     [style.background-position]="'center'">

  <button class="back-btn"
          (click)="goToHome()"
          title="Voltar ao painel">
    &larr;
  </button>

  <button class="edit-btn"
          (click)="openEditCapa()"
          title="Editar capa">
    <span style="display: inline-block; transform: rotate(-45deg);">‚úè</span>
  </button>
</div>

<div class="profile-body">

  <!-- LEFT COLUMN -->
  <div class="profile-left">
    <div class="avatar">
      <img *ngIf="fotoPerfilUrl" [src]="fotoPerfilUrl" alt="Foto de perfil" />
      <span *ngIf="!fotoPerfilUrl">üë§</span>

      <button class="avatar-edit-btn"
              (click)="openEditAvatar()"
              title="Editar foto de perfil">
        <span style="display: inline-block; transform: rotate(-45deg);">‚úè</span>
      </button>
    </div>

    <aside class="profile-sidebar">
      <button class="primary-btn" (click)="openEdit()">Editar conta</button>

      <ul class="menu">
        <li class="menu-item" [class.active]="activeSection === 'overview'" (click)="showOverview()">Prefer√™ncias</li>
        <li class="menu-item" [class.active]="activeSection === 'statistics'" (click)="showStatistics()">Estat√≠sticas</li>
        <li>Conquistas</li>
        <li class="logout" (click)="logout()">Terminar sess√£o</li>
        <li class="logout" (click)="openDeleteConfirm()">Apagar conta</li>
      </ul>

      <div class="xp-level">
        <h3>Progresso</h3>

        <div class="stat-row">
          <span>XP</span>
          <strong>{{ xp }}</strong>
        </div>

        <div class="stat-row">
          <span>N√≠vel</span>
          <strong>{{ level }}</strong>
        </div>

        <div class="xp-bar" aria-hidden="true">
          <div class="xp-fill" [style.width.%]="(xp % 10) * 10"></div>
        </div>

        <div class="xp-text">
          Faltam {{ 10 - (xp % 10) }} XP para o pr√≥ximo n√≠vel
        </div>
      </div>

      <div class="list-counts">
        <div class="stat-row">
          <span>Quero Ver</span>
          <strong>{{ watchLater.length }}</strong>
        </div>
        <div class="stat-row">
          <span>J√° Vi</span>
          <strong>{{ watched.length }}</strong>
        </div>
      </div>
    </aside>
  </div>

  <!-- RIGHT COLUMN -->
  <section class="profile-main">

    <ng-container *ngIf="activeSection === 'overview'">
      <div class="profile-info">
        <h2>{{ userName }}</h2>
        <div class="meta-row">
          <span class="joined">Despertou a For√ßa em &middot; {{ joined }}</span>
        </div>
        <p class="bio">{{ bio || 'Ainda n√£o escreveste a sinopse da tua vida de cin√©filo.' }}</p>
      </div>

      <div class="lists-top">

        <!-- WATCH LATER LIST -->
        <div class="list-box clickable" (click)="openListModal('watchLater')">
          <div class="list-box-left">
            <h3>Quero Ver</h3>
            <span class="subtitle">{{ watchLater.length }} {{ watchLater.length === 1 ? 'filme' : 'filmes' }}</span>
          </div>

          <div class="list-box-right">
            <div class="mini-posters">
              <img *ngFor="let movie of watchLater | slice:0:5"
                   [src]="movie.filme?.posterUrl || 'https://via.placeholder.com/120x180'"
                   alt="Cartaz do filme" />
            </div>

            <button class="pill-btn" title="Ver mais tarde">
              <span class="icon">üöÄ</span>
            </button>
          </div>
        </div>

        <!-- WATCHED LIST -->
        <div class="list-box clickable" (click)="openListModal('watched')">
          <div class="list-box-left">
            <h3>J√° Vi</h3>
            <span class="subtitle">{{ watched.length }} {{ watched.length === 1 ? 'filme' : 'filmes' }}</span>
          </div>

          <div class="list-box-right">
            <div class="mini-posters">
              <img *ngFor="let movie of watched | slice:0:5"
                   [src]="movie.filme?.posterUrl || 'https://via.placeholder.com/120x180'"
                   alt="Cartaz do filme" />
            </div>

            <button class="pill-btn gray" title="Vistos">
              <span class="icon">‚úÖ</span>
            </button>
          </div>
        </div>
      </div>

      <!-- FAVORITES -->
      <div class="section fav-section">
        <div class="section-title">
          <h3>Favoritos</h3>
          <span class="subtitle">Top 10 Filmes &amp; Atores</span>
        </div>

        <div class="fav-header">
          <span class="fav-counter">
            {{ favoritosFilmes.length }}/{{ MAX_FAVORITES }} filmes &middot; {{ favoritosAtores.length }}/{{ MAX_FAVORITES }} atores
          </span>
          <button type="button" class="action-btn ver-todos-fav-btn" (click)="openVerTodosFavoritos()">
            Ver todos os favoritos
          </button>
        </div>

        <div class="fav-grid">

          <!-- Top 10 Movies -->
          <div class="fav-card">
            <div class="fav-card-head">
              <h4>Top 10 Filmes</h4>
              <span class="fav-mini">{{ favoritosFilmesDetalhesTop10.length }}/10</span>
            </div>

            <div class="fav-posters-grid" *ngIf="favoritosFilmesDetalhesTop10.length > 0; else noFavMovies">
              <div class="fav-poster"
                   *ngFor="let f of favoritosFilmesDetalhesTop10; let i = index"
                   draggable="true"
                   [attr.data-index]="i"
                   (dragstart)="onDragStart($event, i)"
                   (dragover)="onDragOver($event)"
                   (drop)="onDrop($event, i)"
                   (dragend)="onDragEnd()"
                   [class.dragging]="draggedIndex === i"
                   [class.drag-over]="dragOverIndex === i"
                   title="Arrasta para reordenar">
                <span class="position-badge">{{ i + 1 }}</span>
                <img [src]="f.posterUrl"
                     [alt]="f.titulo"
                     (dblclick)="removeFromFavorites(f.id)"
                     [title]="f.titulo" />
              </div>
            </div>

            <ng-template #noFavMovies>
              <div class="fav-empty">
                A tua gal√°xia de favoritos ainda est√° vazia.<br />
                <span class="fav-empty-hint">Usa "‚òÖ Favorito" nas p√°ginas dos filmes (at√© {{ MAX_FAVORITES }}) para montar a tua pr√≥pria saga.</span>
              </div>
            </ng-template>
          </div>

          <!-- Top 10 Actors -->
          <div class="fav-card">
            <div class="fav-card-head">
              <h4>Top 10 Atores</h4>
              <span class="fav-mini">{{ favoritosAtoresTop10.length }}/10</span>
            </div>

            <div class="fav-actor-add">
              <input type="text"
                     [(ngModel)]="novoAtor"
                     placeholder="Adicionar nome do ator..."
                     [disabled]="isSavingFavorites || favoritosAtores.length >= MAX_FAVORITES" />

              <button type="button"
                      class="action-btn"
                      (click)="addAtorFavorito()"
                      [disabled]="isSavingFavorites || !novoAtor.trim() || favoritosAtores.length >= MAX_FAVORITES">
                Adicionar
              </button>
            </div>

            <div class="fav-actors-list" *ngIf="favoritosAtoresTop10.length > 0; else noFavActors">
              <div class="fav-actor-card"
                   *ngFor="let a of favoritosAtoresTop10; let i = index"
                   draggable="true"
                   [attr.data-index]="i"
                   (dragstart)="onActorDragStart($event, i)"
                   (dragover)="onActorDragOver($event)"
                   (drop)="onActorDrop($event, i)"
                   (dragend)="onActorDragEnd()"
                   [class.dragging-actor]="draggedActorIndex === i"
                   [class.drag-over-actor]="dragOverActorIndex === i"
                   title="Arrasta para reordenar">
                <span class="actor-rank">{{ i + 1 }}</span>
                <span class="actor-name">{{ a }}</span>
                <button type="button"
                        class="actor-remove-btn"
                        (click)="removeAtorFavorito(a)"
                        [disabled]="isSavingFavorites"
                        title="Remover ator">
                  &times;
                </button>
              </div>
            </div>

            <ng-template #noFavActors>
              <div class="fav-empty">
                Ainda n√£o escolheste o teu elenco de sonho.<br />
                <span class="fav-empty-hint">Adiciona at√© {{ MAX_FAVORITES }} atores para o casting perfeito.</span>
              </div>
            </ng-template>
          </div>

        </div>
      </div>

      <!-- Modal: Ver todos os favoritos -->
      <div class="modal-overlay" *ngIf="showAllFavoritesModal" (click)="closeVerTodosFavoritos()">
        <div class="modal-box modal-favoritos-todos" (click)="$event.stopPropagation()">
          <button class="modal-close" (click)="closeVerTodosFavoritos()">&times;</button>
          <h3>Todos os favoritos</h3>
          <p class="modal-fav-desc">Ordena, remove ou adiciona. Os primeiros 10 s√£o o teu Top 10.</p>

          <div class="fav-modal-grid">
            <div class="fav-modal-col">
              <h4>Filmes ({{ favoritosFilmes.length }})</h4>
              <div class="fav-posters-grid" *ngIf="favoritosFilmesDetalhes.length > 0; else noFavMoviesModal">
                <div class="fav-poster"
                     *ngFor="let f of favoritosFilmesDetalhes; let i = index"
                     draggable="true"
                     [attr.data-index]="i"
                     (dragstart)="onDragStart($event, i)"
                     (dragover)="onDragOver($event)"
                     (drop)="onDrop($event, i)"
                     (dragend)="onDragEnd()"
                     [class.dragging]="draggedIndex === i"
                     [class.drag-over]="dragOverIndex === i"
                     title="Arrasta para reordenar">
                  <span class="position-badge">{{ i + 1 }}</span>
                  <img [src]="f.posterUrl" [alt]="f.titulo"
                       (dblclick)="removeFromFavorites(f.id)"
                       [title]="f.titulo" />
                </div>
              </div>
              <ng-template #noFavMoviesModal>
                <p class="chart-empty">Nenhum filme nos favoritos.</p>
              </ng-template>
            </div>

            <div class="fav-modal-col">
              <h4>Atores ({{ favoritosAtores.length }})</h4>
              <div class="fav-actor-add">
                <input type="text" [(ngModel)]="novoAtor" placeholder="Adicionar ator..."
                       [disabled]="isSavingFavorites || favoritosAtores.length >= MAX_FAVORITES" />
                <button type="button" class="action-btn" (click)="addAtorFavorito()"
                        [disabled]="isSavingFavorites || !novoAtor.trim() || favoritosAtores.length >= MAX_FAVORITES">
                  Adicionar
                </button>
              </div>

              <div class="fav-actors-list" *ngIf="favoritosAtores.length > 0; else noFavActorsModal">
                <div class="fav-actor-card"
                     *ngFor="let a of favoritosAtores; let i = index"
                     draggable="true"
                     [attr.data-index]="i"
                     (dragstart)="onActorDragStart($event, i)"
                     (dragover)="onActorDragOver($event)"
                     (drop)="onActorDrop($event, i)"
                     (dragend)="onActorDragEnd()"
                     [class.dragging-actor]="draggedActorIndex === i"
                     [class.drag-over-actor]="dragOverActorIndex === i"
                     title="Arrasta para reordenar">
                  <span class="actor-rank">{{ i + 1 }}</span>
                  <span class="actor-name">{{ a }}</span>
                  <button type="button" class="actor-remove-btn" (click)="removeAtorFavorito(a)" [disabled]="isSavingFavorites" title="Remover">&times;</button>
                </div>
              </div>

              <ng-template #noFavActorsModal>
                <p class="chart-empty">Nenhum ator nos favoritos.</p>
              </ng-template>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="save-btn" (click)="closeVerTodosFavoritos()">Fechar</button>
          </div>
        </div>
      </div>

    </ng-container>

    <!-- Estat√≠sticas -->
    <ng-container *ngIf="activeSection === 'statistics'">
      <div class="statistics-view">
        <div class="stats-period-filter">
          <label for="statsPeriod">Filtrar por per√≠odo:</label>
          <div class="sort-wrap">
            <button type="button" class="sort-btn" (click)="toggleStatsPeriodMenu()"
                    [class.active]="showStatsPeriodMenu"
                    aria-label="Filtrar por per√≠odo"
                    aria-haspopup="true"
                    [attr.aria-expanded]="showStatsPeriodMenu">
              {{ getCurrentPeriodLabel() }}
            </button>

            <div class="sort-menu" *ngIf="showStatsPeriodMenu" role="menu" aria-label="Op√ß√µes de per√≠odo">
              <button type="button"
                      class="sort-item"
                      (click)="selectStatsPeriod(opt.value)"
                      [class.selected]="statsPeriod === opt.value"
                      role="menuitem"
                      *ngFor="let opt of statsPeriodOptions">
                {{ opt.label }}
              </button>
            </div>
          </div>
        </div>

        <section class="stats-block stats-in-main stats">
          <h3>Estat√≠sticas</h3>
          <div class="stat-row">
            <span>Filmes vistos</span>
            <strong>{{ stats?.totalFilmes || 0 }}</strong>
          </div>
          <div class="stat-row">
            <span>Tempo total</span>
            <strong>{{ (stats?.totalMinutos || 0) | formatDuration }}</strong>
          </div>
          <div class="genres" *ngIf="stats?.generos?.length">
            <div class="genre-row" *ngFor="let g of stats.generos">
              <span>{{ g.genero }}</span>
              <span>{{ g.total }}</span>
            </div>
          </div>
        </section>

        <section class="stats-comparison stats-comparison-in-main" *ngIf="statsComparison">
          <h3>Tu vs M√©dia Global</h3>

          <div class="comparison-item">
            <div class="comparison-label">Filmes vistos</div>
            <div class="comparison-bars">
              <div class="bar-row">
                <span class="bar-label">Tu</span>
                <div class="bar-container">
                  <div class="bar user-bar"
                       [style.width.%]="getComparisonBarWidth(statsComparison.user.totalFilmes, statsComparison.global.mediaFilmesPorUtilizador)"
                       [style.background]="getUserBarGradient()"></div>
                </div>
                <span class="bar-value">{{ statsComparison.user.totalFilmes }}</span>
              </div>
              <div class="bar-row">
                <span class="bar-label">M√©dia</span>
                <div class="bar-container">
                  <div class="bar global-bar"
                       [style.width.%]="getGlobalBarWidth(statsComparison.user.totalFilmes, statsComparison.global.mediaFilmesPorUtilizador)"
                       [style.background]="getGlobalBarGradient()"></div>
                </div>
                <span class="bar-value">{{ statsComparison.global.mediaFilmesPorUtilizador }}</span>
              </div>
            </div>
            <div class="comparison-indicator"
                 [class.positive]="statsComparison.comparacao.filmesMaisQueMedia"
                 [class.negative]="!statsComparison.comparacao.filmesMaisQueMedia">
              <span *ngIf="statsComparison.comparacao.filmesVsMedia >= 0">+</span>{{ statsComparison.comparacao.filmesVsMedia | number:'1.0-1' }} vs m√©dia
            </div>
          </div>

          <div class="comparison-item">
            <div class="comparison-label">Horas vistas</div>
            <div class="comparison-bars">
              <div class="bar-row">
                <span class="bar-label">Tu</span>
                <div class="bar-container">
                  <div class="bar user-bar"
                       [style.width.%]="getComparisonBarWidth(statsComparison.user.totalHoras, statsComparison.global.mediaHorasPorUtilizador)"
                       [style.background]="getUserBarGradient()"></div>
                </div>
                <span class="bar-value">{{ statsComparison.user.totalHoras }}h</span>
              </div>
              <div class="bar-row">
                <span class="bar-label">M√©dia</span>
                <div class="bar-container">
                  <div class="bar global-bar"
                       [style.width.%]="getGlobalBarWidth(statsComparison.user.totalHoras, statsComparison.global.mediaHorasPorUtilizador)"
                       [style.background]="getGlobalBarGradient()"></div>
                </div>
                <span class="bar-value">{{ statsComparison.global.mediaHorasPorUtilizador }}h</span>
              </div>
            </div>
            <div class="comparison-indicator"
                 [class.positive]="statsComparison.comparacao.horasMaisQueMedia"
                 [class.negative]="!statsComparison.comparacao.horasMaisQueMedia">
              <span *ngIf="statsComparison.comparacao.horasVsMedia >= 0">+</span>{{ statsComparison.comparacao.horasVsMedia }}h vs m√©dia
            </div>
          </div>

          <div class="percentile-box">
            <div class="percentile-value">Top {{ 100 - statsComparison.comparacao.percentilFilmes }}%</div>
            <div class="percentile-label">dos utilizadores da plataforma</div>
          </div>

          <div class="platform-info">
            <span>{{ statsComparison.global.totalUtilizadores }} utilizadores na plataforma</span>
          </div>
        </section>
      </div>

      <!-- Charts -->
      <section class="charts-section" *ngIf="chartData">
        <div class="charts-header">
          <h3 class="charts-title">Estat√≠sticas em gr√°fico</h3>

          <div style="position: relative;">
            <button class="graph-customize-btn"
                    [class.active]="showGraphCustomizeMenu"
                    (click)="toggleGraphCustomize()"
                    title="Personalizar gr√°ficos">
              ‚öô
            </button>

            <div class="graph-customize-menu" *ngIf="showGraphCustomizeMenu">
              <h4 class="customize-menu-title">Defini√ß√µes dos gr√°ficos</h4>

              <div class="customize-section">
                <h5 class="customize-section-title">Visibilidade</h5>
                <div class="visibility-list">
                  <div class="visibility-item">
                    <span class="visibility-label">Filmes por dura√ß√£o</span>
                    <div class="toggle-switch"
                         [class.active]="graphSettings.showGenreBar"
                         (click)="toggleGraphVisibility('showGenreBar')">
                      <div class="toggle-slider"></div>
                    </div>
                  </div>

                  <div class="visibility-item">
                    <span class="visibility-label">Distribui√ß√£o por dura√ß√£o</span>
                    <div class="toggle-switch"
                         [class.active]="graphSettings.showGenrePie"
                         (click)="toggleGraphVisibility('showGenrePie')">
                      <div class="toggle-slider"></div>
                    </div>
                  </div>

                  <div class="visibility-item">
                    <span class="visibility-label">Filmes por per√≠odo</span>
                    <div class="toggle-switch"
                         [class.active]="graphSettings.showPeriodBar"
                         (click)="toggleGraphVisibility('showPeriodBar')">
                      <div class="toggle-slider"></div>
                    </div>
                  </div>

                  <div class="visibility-item">
                    <span class="visibility-label">Distribui√ß√£o por per√≠odo</span>
                    <div class="toggle-switch"
                         [class.active]="graphSettings.showPeriodPie"
                         (click)="toggleGraphVisibility('showPeriodPie')">
                      <div class="toggle-slider"></div>
                    </div>
                  </div>

                  <div class="visibility-item">
                    <span class="visibility-label">Gr√°fico por m√™s</span>
                    <div class="toggle-switch"
                         [class.active]="graphSettings.showMonthlyChart"
                         (click)="toggleGraphVisibility('showMonthlyChart')">
                      <div class="toggle-slider"></div>
                    </div>
                  </div>

                  <div class="visibility-item">
                    <span class="visibility-label">Percentagens de g√©neros</span>
                    <div class="toggle-switch"
                         [class.active]="graphSettings.showGenrePercentages"
                         (click)="toggleGraphVisibility('showGenrePercentages')">
                      <div class="toggle-slider"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="customize-section">
                <h5 class="customize-section-title">Cores do gr√°fico mensal</h5>
                <div class="color-pickers">
                  <div class="color-picker-item">
                    <span class="color-picker-label">Cor (tu)</span>
                    <div class="color-picker-input">
                      <input type="color"
                             [(ngModel)]="graphSettings.userColor"
                             (change)="updateGraphColors()">
                    </div>
                  </div>
                  <div class="color-picker-item">
                    <span class="color-picker-label">Cor (m√©dia global)</span>
                    <div class="color-picker-input">
                      <input type="color"
                             [(ngModel)]="graphSettings.globalColor"
                             (change)="updateGraphColors()">
                    </div>
                  </div>
                </div>
              </div>

              <div class="customize-section">
                <h5 class="customize-section-title">Cores dos gr√°ficos</h5>
                <div class="color-pickers">
                  <div class="color-picker-item">
                    <span class="color-picker-label">Cor 1</span>
                    <div class="color-picker-input">
                      <input type="color" [(ngModel)]="graphSettings.chartColor1" (change)="updateGraphColors()">
                    </div>
                  </div>
                  <div class="color-picker-item">
                    <span class="color-picker-label">Cor 2</span>
                    <div class="color-picker-input">
                      <input type="color" [(ngModel)]="graphSettings.chartColor2" (change)="updateGraphColors()">
                    </div>
                  </div>
                  <div class="color-picker-item">
                    <span class="color-picker-label">Cor 3</span>
                    <div class="color-picker-input">
                      <input type="color" [(ngModel)]="graphSettings.chartColor3" (change)="updateGraphColors()">
                    </div>
                  </div>
                  <div class="color-picker-item">
                    <span class="color-picker-label">Cor 4</span>
                    <div class="color-picker-input">
                      <input type="color" [(ngModel)]="graphSettings.chartColor4" (change)="updateGraphColors()">
                    </div>
                  </div>
                  <div class="color-picker-item">
                    <span class="color-picker-label">Cor 5</span>
                    <div class="color-picker-input">
                      <input type="color" [(ngModel)]="graphSettings.chartColor5" (change)="updateGraphColors()">
                    </div>
                  </div>
                </div>
              </div>

              <button class="customize-reset-btn" (click)="resetGraphSettings()">
                Repor predefinidos
              </button>
            </div>
          </div>
        </div>

        <div class="charts-grid">
          <div class="chart-card" [class.hidden]="!graphSettings.showGenreBar">
            <h4>Filmes por dura√ß√£o</h4>
            <div class="chart-bar-container" *ngIf="chartData.porDuracao?.length; else noDuracao">
              <div class="chart-bar-row" *ngFor="let d of chartData.porDuracao; let i = index">
                <span class="chart-bar-label">{{ d.label }}</span>
                <div class="chart-bar-track">
                  <div class="chart-bar-fill"
                       [style.width.%]="chartBarWidthDuracao(d.total)"
                       [style.background]="getCustomChartColor(i)"></div>
                </div>
                <span class="chart-bar-value">{{ d.total }}</span>
              </div>
            </div>
            <ng-template #noDuracao>
              <p class="chart-empty">Ainda n√£o h√° dados por dura√ß√£o ‚Äî v√™ mais filmes e desbloqueia o gr√°fico das tuas maratonas.</p>
            </ng-template>
          </div>

          <div class="chart-card" [class.hidden]="!graphSettings.showGenrePie">
            <h4>Distribui√ß√£o por dura√ß√£o</h4>
            <div class="chart-pie-wrap" *ngIf="chartData.porDuracao?.length; else noPieDuracao">
              <svg class="chart-pie" viewBox="0 0 100 100">
                <path *ngFor="let d of chartData.porDuracao; let i = index"
                      [attr.d]="pieSegmentDDuracao(i)"
                      [attr.fill]="getCustomChartColor(i)"
                      class="chart-pie-segment" />
              </svg>

              <div class="chart-pie-legend">
                <span *ngFor="let d of chartData.porDuracao; let i = index" class="chart-legend-item">
                  <i [style.background]="getCustomChartColor(i)"></i>
                  {{ d.label }} ‚Äî {{ duracaoPercent(d.total) | number:'1.0-0' }}% ({{ d.total }})
                </span>
              </div>
            </div>
            <ng-template #noPieDuracao>
              <p class="chart-empty">Ainda n√£o h√° dados por dura√ß√£o ‚Äî quando come√ßares a fazer binge‚Äëwatch, mostramos aqui.</p>
            </ng-template>
          </div>

          <div class="chart-card" [class.hidden]="!graphSettings.showPeriodBar">
            <h4>Filmes por per√≠odo (ano de estreia)</h4>

            <div class="period-lollipop" *ngIf="chartData.porIntervaloAnos?.length; else noIntervaloAnos">
              <div class="period-row" *ngFor="let d of chartData.porIntervaloAnos; let i = index">
                <span class="period-label">{{ d.label }}</span>

                <div class="period-track">
                  <div class="period-line"></div>
                  <div class="period-dot"
                       [style.left.%]="lollipopPosIntervaloAnos(d.total)"
                       [style.background]="getCustomChartColor(i)"
                       [attr.title]="d.total + ' filmes'">
                  </div>
                </div>

                <span class="period-value">{{ d.total }}</span>
              </div>
            </div>
            <ng-template #noIntervaloAnos>
              <p class="chart-empty">Ainda n√£o h√° dados por ano ‚Äî assim que vires mais estreias, desenhamos a tua linha temporal de cinema.</p>
            </ng-template>
          </div>


          <div class="chart-card" [class.hidden]="!graphSettings.showPeriodPie">
            <h4>Distribui√ß√£o por per√≠odo</h4>

            <div class="period-waffle-wrap"
                 *ngIf="chartData.porIntervaloAnos?.length && totalIntervaloAnosVistos > 0; else noPieIntervaloAnos">

              <div class="period-waffle-grid" role="img" aria-label="Distribui√ß√£o por per√≠odo em waffle">
                <div class="period-waffle-cell"
                     *ngFor="let cell of periodWaffleCells"
                     [style.background]="getCustomChartColor(cell.i)"
                     [attr.title]="cell.label">
                </div>
              </div>

              <div class="chart-pie-legend">
                <span *ngFor="let d of chartData.porIntervaloAnos; let i = index" class="chart-legend-item">
                  <i [style.background]="getCustomChartColor(i)"></i>
                  {{ d.label }} ‚Äî {{ intervaloAnosPercent(d.total) | number:'1.0-0' }}% ({{ d.total }})
                </span>
              </div>
            </div>
            <ng-template #noPieIntervaloAnos>
              <p class="chart-empty">Ainda n√£o h√° dados por per√≠odo ‚Äî continua a viajar entre cl√°ssicos e novidades para preencher este mapa.</p>
            </ng-template>
          </div>


          <div class="chart-card chart-card-full" [class.hidden]="!graphSettings.showMonthlyChart">
            <h4>{{ getChartTitle() }}</h4>
            <div class="chart-bar-container" *ngIf="chartData.porMes && chartData.porMes.length > 0; else noLine">
              <div class="chart-bars-grid">
                <div *ngFor="let m of chartData.porMes; let i = index" class="chart-bar-month">
                  <div class="chart-bars-pair">
                    <div class="chart-bar user-bar"
                         [style.height.%]="getBarHeight(m.total)"
                         [style.background]="getUserBarGradient()"
                         [attr.title]="m.total + ' filmes (Tu)'">
                      <div class="chart-bar-value">{{ m.total }}</div>
                    </div>

                    <div class="chart-bar global-bar"
                         [style.height.%]="getBarHeight(getGlobalAverageForMonth(m))"
                         [style.background]="getGlobalBarGradient()"
                         [attr.title]="getGlobalAverageForMonth(m).toFixed(1) + ' filmes (M√©dia)'">
                      <div class="chart-bar-value">{{ getGlobalAverageForMonth(m).toFixed(1) }}</div>
                    </div>
                  </div>
                  <div class="chart-bar-label">{{ m.label }}</div>
                </div>
              </div>

              <div class="chart-line-legend">
                <span class="legend-item user-legend">
                  <i class="legend-dot" [style.background]="graphSettings.userColor"></i>
                  Tu
                </span>
                <span class="legend-item global-legend">
                  <i class="legend-dot" [style.background]="graphSettings.globalColor"></i>
                  M√©dia global
                </span>
              </div>
            </div>

            <ng-template #noLine>
              <p class="chart-empty">Ainda n√£o h√° dados por m√™s ‚Äî quando o calend√°rio de sess√µes encher, mostramos aqui o teu ritmo de visualiza√ß√µes.</p>
            </ng-template>
          </div>
        </div>
      </section>

      <section class="charts-section fr32-section" *ngIf="genrePercentages.length && graphSettings.showGenrePercentages">
        <h3 class="charts-title">Percentagens de g√©neros mais vistos</h3>

        <div class="charts-grid">
          <div class="chart-card chart-card-full">
            <h4>Distribui√ß√£o em percentagem</h4>

            <div class="fr32-bars">
              <div class="fr32-row" *ngFor="let g of genrePercentages; let i = index">
                <span class="fr32-label">{{ g.genero }}</span>

                <div class="fr32-track">
                  <div class="fr32-fill"
                       [style.width.%]="g.percent"
                       [style.background]="getCustomChartColor(i)"></div>
                </div>

                <span class="fr32-value">
                  {{ g.percent | number:'1.0-0' }}%
                  <span class="fr32-mini">({{ g.total }})</span>
                </span>
              </div>
            </div>

            <p class="fr32-total" *ngIf="totalGenerosVistos">
              Total analisado: <strong>{{ totalGenerosVistos }}</strong> g√©neros vistos
            </p>
          </div>
        </div>
      </section>

      <div class="charts-section loading" *ngIf="isLoadingCharts && !chartData">A carregar gr√°ficos...</div>
      <p class="chart-empty" *ngIf="!isLoadingCharts && !chartData">Sem dados para mostrar.</p>
    </ng-container>

  </section>
</div>

<!-- EDITAR a Conta (Username e Bio) -->
<div class="modal-overlay" *ngIf="isEditing" (click)="closeEdit()">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeEdit()">&times;</button>

    <h3>Editar conta</h3>

    <form (ngSubmit)="saveChanges()">
      <label for="userName">Nome de utilizador</label>
      <input id="userName" name="userName" type="text" [(ngModel)]="editUserName" required />

      <label for="bio">Bio</label>
      <textarea id="bio" name="bio" rows="4" [(ngModel)]="editBio"></textarea>

      <div class="modal-actions">
        <button type="submit" class="save-btn">Guardar</button>
        <button type="button" class="cancel-btn" (click)="closeEdit()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- EDITAR Capa -->
<div class="modal-overlay" *ngIf="isEditingCapa" (click)="closeEditCapa()">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeEditCapa()">&times;</button>

    <h3>Editar foto de capa</h3>

    <form (ngSubmit)="saveCapa()">
      <label for="capaFile">Foto de capa</label>
      <div class="image-preview-container">
        <img *ngIf="editCapaUrl" [src]="editCapaUrl" alt="Pr√©-visualiza√ß√£o da capa" class="image-preview" />
        <input id="capaFile" name="capaFile" type="file" accept="image/*" (change)="onCapaFileSelected($event)" />
      </div>

      <div class="modal-actions">
        <button type="submit" class="save-btn">Guardar</button>
        <button type="button" class="cancel-btn" (click)="closeEditCapa()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- EDITAR Avatar -->
<div class="modal-overlay" *ngIf="isEditingAvatar" (click)="closeEditAvatar()">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeEditAvatar()">&times;</button>

    <h3>Editar foto de perfil</h3>

    <form (ngSubmit)="saveAvatar()">
      <label for="avatarFile">Foto de perfil</label>
      <div class="image-preview-container">
        <img *ngIf="editFotoPerfilUrl" [src]="editFotoPerfilUrl" alt="Pr√©-visualiza√ß√£o do avatar" class="image-preview avatar-preview" />
        <input id="avatarFile" name="avatarFile" type="file" accept="image/*" (change)="onAvatarFileSelected($event)" />
      </div>

      <div class="modal-actions">
        <button type="submit" class="save-btn">Guardar</button>
        <button type="button" class="cancel-btn" (click)="closeEditAvatar()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- LIST Menus Watched e Watch Later -->
<div class="modal-overlay list-modal-overlay" *ngIf="showListModal" (click)="closeListModal()">
  <div class="list-modal-box" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeListModal()">&times;</button>

    <h3>{{ currentListTitle }}</h3>
    <span class="list-subtitle">
      {{ filteredCurrentList.length }} {{ filteredCurrentList.length === 1 ? 'filme' : 'filmes' }}
    </span>

    <div class="filter-row" *ngIf="currentListType === 'watchLater'">
      <label for="wlFilter">Filtrar:</label>
      <select id="wlFilter" [(ngModel)]="watchLaterFilter">
        <option value="all">Todos (mais recentes primeiro)</option>
        <option value="newest">Mais recentes primeiro</option>
        <option value="oldest">Mais antigos primeiro</option>
        <option value="7days">Adicionados nos √∫ltimos 7 dias</option>
        <option value="30days">Adicionados nos √∫ltimos 30 dias</option>
      </select>
    </div>

    <div class="filter-row" *ngIf="currentListType === 'watched'">
      <label for="watFilter">Filtrar:</label>
      <select id="watFilter" [(ngModel)]="watchedFilter">
        <option value="all">Todos (mais recentes primeiro)</option>
        <option value="newest">Mais recentes primeiro</option>
        <option value="oldest">Mais antigos primeiro</option>
        <option value="7days">Adicionados nos √∫ltimos 7 dias</option>
        <option value="30days">Adicionados nos √∫ltimos 30 dias</option>
      </select>
    </div>

    <div class="expanded-posters-grid" *ngIf="filteredCurrentList.length > 0">
      <div class="expanded-poster-card" *ngFor="let movie of filteredCurrentList">
        <img [src]="movie.filme?.posterUrl || movie.filme?.PosterUrl || 'https://via.placeholder.com/200x300'"
             [alt]="movie.filme?.titulo || movie.filme?.Titulo || 'Cartaz do filme'"
             class="expanded-poster" />
        <div class="poster-info">
          <div class="poster-title">{{ movie.filme?.titulo || movie.filme?.Titulo || 'Desconhecido' }}</div>
          <div class="poster-meta">
            <span *ngIf="movie.filme?.genero || movie.filme?.Genero">{{ movie.filme?.genero || movie.filme?.Genero }}</span>
            <span *ngIf="movie.filme?.duracao || movie.filme?.Duracao"> &middot; {{ (movie.filme?.duracao ?? movie.filme?.Duracao) | formatDuration }}</span>
          </div>
          <div class="poster-date" *ngIf="(movie.data || movie.Data)">
            Adicionado: {{ (movie.data || movie.Data) | date:'dd/MM/yyyy, HH:mm':'':'pt-PT' }}
          </div>
        </div>
      </div>
    </div>

    <div class="empty-list-message" *ngIf="filteredCurrentList.length === 0">
      <p>Nenhum filme nesta lista ainda.</p>
    </div>
  </div>
</div>

<!-- APAGAR a Conta -->
<div class="modal-overlay" *ngIf="isDeleting" (click)="closeDeleteConfirm()">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeDeleteConfirm()">&times;</button>

    <h3>Apagar conta</h3>
    <p class="delete-info">Para apagar a sua conta escreva <strong>delete</strong></p>

    <form (ngSubmit)="confirmDelete()">
      <input id="deleteInput"
             name="deleteInput"
             type="text"
             [(ngModel)]="deleteInput"
             autocomplete="off"
             aria-label="Escreva 'delete' para confirmar" />

      <div class="modal-actions">
        <button type="submit"
                class="danger-btn"
                [disabled]="(deleteInput || '').trim().toLowerCase() !== deleteRequiredText || isDeletingSaving">
          Confirmar
        </button>

        <button type="button"
                class="cancel-btn"
                (click)="closeDeleteConfirm()"
                [disabled]="isDeletingSaving">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>
