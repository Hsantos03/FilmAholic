<!-- Header -->
<div class="profile-header" [style.background-image]="capaUrl ? 'url(' + capaUrl + ')' : 'none'" [style.background-size]="'cover'" [style.background-position]="'center'">
  <button class="back-btn" (click)="goToHome()" title="Voltar √É∆í√Ç¬† homepage">‚Üê¬ê</button>
  <button class="edit-btn" (click)="openEditCapa()" title="Editar capa">‚úé</button>
</div>

<div class="profile-body">

  <!-- LEFT COLUMN -->
  <div class="profile-left">
    <div class="avatar">
      <img *ngIf="fotoPerfilUrl" [src]="fotoPerfilUrl" alt="Profile picture" />
      <span *ngIf="!fotoPerfilUrl">üë§</span>
      <button class="avatar-edit-btn" (click)="openEditAvatar()" title="Editar foto de perfil">‚úèÔ∏è</button>
    </div>

    <aside class="profile-sidebar">
      <button class="primary-btn" (click)="openEdit()">Manage Account</button>

      <ul class="menu">
        <li>Preferences</li>
        <li>Achievements</li>
        <li class="logout" (click)="logout()">Log out</li>
        <li class="logout" (click)="openDeleteConfirm()">Delete account</li>
      </ul>

      <div class="stats">
        <h3>Statistics</h3>

        <div class="stat-row">
          <span>Movies watched</span>
          <strong>{{ stats?.totalFilmes || 0 }}</strong>
        </div>

        <div class="stat-row">
          <span>Total minutes</span>
          <strong>{{ stats?.totalMinutos || 0 }} min</strong>
        </div>

        <div class="genres" *ngIf="stats?.generos?.length">
          <div class="genre-row" *ngFor="let g of stats.generos">
            <span>{{ g.genero }}</span>
            <span>{{ g.total }}</span>
          </div>
        </div>
      </div>

      <div class="xp-level">
        <h3>Progress</h3>

        <div class="stat-row">
          <span>XP</span>
          <strong>{{ xp }}</strong>
        </div>

        <div class="stat-row">
          <span>Level</span>
          <strong>{{ level }}</strong>
        </div>

        <div class="xp-bar" aria-hidden="true">
          <div class="xp-fill" [style.width.%]="(xp % 10) * 10"></div>
        </div>

        <div class="xp-text">
          Next level in {{ 10 - (xp % 10) }} XP
        </div>
      </div>

      <div class="list-counts">
        <div class="stat-row">
          <span>Watch later</span>
          <strong>{{ watchLater.length }}</strong>
        </div>
        <div class="stat-row">
          <span>Watched</span>
          <strong>{{ watched.length }}</strong>
        </div>
      </div>
    </aside>
  </div>

  <!-- RIGHT COLUMN -->
  <section class="profile-main">

    <div class="profile-info">
      <h2>{{ userName }}</h2>
      <div class="meta-row">
        <span class="joined">Joined √Ç¬∑ {{ joined }}</span>
      </div>
      <p class="bio">{{ bio || 'No information yet' }}</p>
    </div>

    <div class="lists-top">

      <!-- WATCH LATER LIST -->
      <div class="list-box clickable" (click)="openListModal('watchLater')">
        <div class="list-box-left">
          <h3>Watch later</h3>
          <span class="subtitle">{{ watchLater.length }} Titles</span>
        </div>

        <div class="list-box-right">
          <div class="mini-posters">
            <img *ngFor="let movie of watchLater | slice:0:5"
                 [src]="movie.filme?.posterUrl || 'https://via.placeholder.com/120x180'"
                 alt="movie poster" />
          </div>

          <button class="pill-btn" title="Watch later">
            <span class="icon">üöÄ</span>
          </button>
        </div>
      </div>

      <!-- Watched LIST -->
      <div class="list-box clickable" (click)="openListModal('watched')">
        <div class="list-box-left">
          <h3>Watched</h3>
          <span class="subtitle">{{ watched.length }} Titles</span>
        </div>

        <div class="list-box-right">
          <div class="mini-posters">
            <img *ngFor="let movie of watched | slice:0:5"
                 [src]="movie.filme?.posterUrl || 'https://via.placeholder.com/120x180'"
                 alt="movie poster" />
          </div>

          <button class="pill-btn gray" title="Watched">
            <span class="icon">üëÅÔ∏è¬è</span>
          </button>
        </div>
      </div>
    </div>

    <!-- FAVORITES (mais organizado) -->
    <div class="section fav-section">
      <div class="section-title">
        <h3>Favorites</h3>
        <span class="subtitle">Top 10 Movies & Actors</span>
      </div>

      <div class="fav-header">
        <label class="fav-toggle">
          <input type="checkbox" [(ngModel)]="showOnlyFavorites" />
          <span>Show only favorites in catalog</span>
        </label>

        <span class="fav-counter">
          {{ favoritosFilmes.length }}/10 movies √Ç¬∑ {{ favoritosAtores.length }}/10 actors
        </span>
      </div>

      <div class="fav-grid">

        <!-- Top 10 Movies -->
        <div class="fav-card">
          <div class="fav-card-head">
            <h4>Top 10 Movies</h4>
            <span class="fav-mini">{{ favoritosFilmes.length }}/10</span>
          </div>

          <div class="fav-posters-grid" *ngIf="favoritosFilmesDetalhes.length > 0; else noFavMovies">
            <div class="fav-poster" 
                 *ngFor="let f of favoritosFilmesDetalhes; let i = index"
                 draggable="true"
                 [attr.data-index]="i"
                 (dragstart)="onDragStart($event, i)"
                 (dragover)="onDragOver($event)"
                 (drop)="onDrop($event, i)"
                 (dragend)="onDragEnd()"
                 [class.dragging]="draggedIndex === i"
                 [class.drag-over]="dragOverIndex === i"
                 title="Drag to reorder">
              <span class="position-badge">{{ i + 1 }}</span>
              <img [src]="f.posterUrl" 
                   [alt]="f.titulo"
                   (dblclick)="removeFromFavorites(f.id)"
                   title="Double-click to remove from favorites" />
            </div>
          </div>

          <ng-template #noFavMovies>
            <div class="fav-empty">
              No favorite movies yet.<br />
              <span class="fav-empty-hint">Use "√¢Àú‚Ä¶ Favorite" in the catalog (max 10).</span>
            </div>
          </ng-template>
        </div>

        <!-- Top 10 Actors -->
        <div class="fav-card">
          <div class="fav-card-head">
            <h4>Top 10 Actors</h4>
            <span class="fav-mini">{{ favoritosAtores.length }}/10</span>
          </div>

          <div class="fav-actor-add">
            <input type="text"
                   [(ngModel)]="novoAtor"
                   placeholder="Add actor name..."
                   [disabled]="isSavingFavorites || favoritosAtores.length >= 10" />

            <button type="button"
                    class="action-btn"
                    (click)="addAtorFavorito()"
                    [disabled]="isSavingFavorites || !novoAtor.trim() || favoritosAtores.length >= 10">
              Add
            </button>
          </div>

          <div class="fav-actors-list" *ngIf="favoritosAtores.length > 0; else noFavActors">
            <div class="fav-actor-card" 
                 *ngFor="let a of favoritosAtores; let i = index"
                 draggable="true"
                 [attr.data-index]="i"
                 (dragstart)="onActorDragStart($event, i)"
                 (dragover)="onActorDragOver($event)"
                 (drop)="onActorDrop($event, i)"
                 (dragend)="onActorDragEnd()"
                 [class.dragging-actor]="draggedActorIndex === i"
                 [class.drag-over-actor]="dragOverActorIndex === i"
                 title="Drag to reorder">
              <span class="actor-rank">{{ i + 1 }}</span>
              <span class="actor-name">{{ a }}</span>
              <button type="button" 
                      class="actor-remove-btn" 
                      (click)="removeAtorFavorito(a)" 
                      [disabled]="isSavingFavorites"
                      title="Remove actor">&times;</button>
            </div>
          </div>

          <ng-template #noFavActors>
            <div class="fav-empty">
              No favorite actors yet.<br />
              <span class="fav-empty-hint">Add up to 10.</span>
            </div>
          </ng-template>
        </div>

      </div>
    </div>

    <!-- CAT√É∆í√Ç¬ÅLOGO -->
    <div class="section">
      <div class="section-title">
        <h3>Catalog</h3>
        <span class="subtitle">Hardcoded movies (FilmSeed)</span>
      </div>

      <div class="cards">
        <div class="movie-card" *ngFor="let f of catalogoFiltrado">
          <img class="poster" [src]="f.posterUrl" [alt]="f.titulo" />

          <div class="movie-meta">
            <div class="movie-title">{{ f.titulo }}</div>
            <div class="movie-sub">{{ f.genero }} √Ç¬∑ {{ f.duracao }} min</div>
          </div>

          <div class="movie-actions">
            <button class="action-btn"
                    (click)="addToWatchLater(f.id)"
                    [disabled]="isSavingMovie || inWatchLater(f.id)">
              + Watch later
            </button>

            <button class="action-btn ghost"
                    (click)="addToWatched(f.id)"
                    [disabled]="isSavingMovie || inWatched(f.id)">
              √¢≈ì‚Äú Watched
            </button>

            <button class="action-btn danger"
                    *ngIf="inWatchLater(f.id) || inWatched(f.id)"
                    (click)="removeFromLists(f.id)"
                    [disabled]="isSavingMovie">
              Remove
            </button>

            <button class="action-btn ghost fav-btn"
                    type="button"
                    (click)="toggleFavoriteFilme(f.id)"
                    [disabled]="isSavingFavorites"
                    [class.selected]="isFilmeFavorito(f.id)">
              √¢Àú‚Ä¶ Favorite
            </button>
          </div>
        </div>
      </div>
    </div>

  </section>
</div>

<!-- EDITAR a Conta (Username e Bio) -->
<div class="modal-overlay" *ngIf="isEditing" (click)="closeEdit()">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeEdit()">&times;</button>

    <h3>Edit account</h3>

    <form (ngSubmit)="saveChanges()">
      <label for="userName">Username</label>
      <input id="userName" name="userName" type="text" [(ngModel)]="editUserName" required />

      <label for="bio">Bio</label>
      <textarea id="bio" name="bio" rows="4" [(ngModel)]="editBio"></textarea>

      <div class="modal-actions">
        <button type="submit" class="save-btn">Save</button>
        <button type="button" class="cancel-btn" (click)="closeEdit()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- EDITAR Capa -->
<div class="modal-overlay" *ngIf="isEditingCapa" (click)="closeEditCapa()">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeEditCapa()">&times;</button>

    <h3>Edit Cover Photo</h3>

    <form (ngSubmit)="saveCapa()">
      <label for="capaFile">Cover Photo</label>
      <div class="image-preview-container">
        <img *ngIf="editCapaUrl" [src]="editCapaUrl" alt="Cover preview" class="image-preview" />
        <input id="capaFile" name="capaFile" type="file" accept="image/*" (change)="onCapaFileSelected($event)" />
      </div>

      <div class="modal-actions">
        <button type="submit" class="save-btn">Save</button>
        <button type="button" class="cancel-btn" (click)="closeEditCapa()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- EDITAR Avatar -->
<div class="modal-overlay" *ngIf="isEditingAvatar" (click)="closeEditAvatar()">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeEditAvatar()">&times;</button>

    <h3>Edit Profile Picture</h3>

    <form (ngSubmit)="saveAvatar()">
      <label for="avatarFile">Profile Picture</label>
      <div class="image-preview-container">
        <img *ngIf="editFotoPerfilUrl" [src]="editFotoPerfilUrl" alt="Avatar preview" class="image-preview avatar-preview" />
        <input id="avatarFile" name="avatarFile" type="file" accept="image/*" (change)="onAvatarFileSelected($event)" />
      </div>

      <div class="modal-actions">
        <button type="submit" class="save-btn">Save</button>
        <button type="button" class="cancel-btn" (click)="closeEditAvatar()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div class="modal-overlay list-modal-overlay" *ngIf="showListModal" (click)="closeListModal()">
  <div class="list-modal-box" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeListModal()">&times;</button>

    <h3>{{ currentListTitle }}</h3>
    <span class="list-subtitle">{{ filteredCurrentList.length }} {{ filteredCurrentList.length === 1 ? 'Title' : 'Titles' }}</span>

    <!-- filter menu for watch later -->
    <div class="filter-row" *ngIf="currentListType === 'watchLater'">
      <label for="wlFilter">Filter:</label>
      <select id="wlFilter" [(ngModel)]="watchLaterFilter">
        <option value="all">All (newest first)</option>
        <option value="newest">Newest first</option>
        <option value="oldest">Oldest first</option>
        <option value="7days">Added last 7 days</option>
        <option value="30days">Added last 30 days</option>
      </select>
    </div>

    <!-- filter menu for watched -->
    <div class="filter-row" *ngIf="currentListType === 'watched'">
      <label for="watFilter">Filter:</label>
      <select id="watFilter" [(ngModel)]="watchedFilter">
        <option value="all">All (newest first)</option>
        <option value="newest">Newest first</option>
        <option value="oldest">Oldest first</option>
        <option value="7days">Added last 7 days</option>
        <option value="30days">Added last 30 days</option>
      </select>
    </div>

    <div class="expanded-posters-grid" *ngIf="filteredCurrentList.length > 0">
      <div class="expanded-poster-card" *ngFor="let movie of filteredCurrentList">
        <img [src]="movie.filme?.posterUrl || movie.filme?.PosterUrl || 'https://via.placeholder.com/200x300'"
             [alt]="movie.filme?.titulo || movie.filme?.Titulo || 'Movie poster'"
             class="expanded-poster" />
        <div class="poster-info">
          <div class="poster-title">{{ movie.filme?.titulo || movie.filme?.Titulo || 'Unknown' }}</div>
          <div class="poster-meta">
            <span *ngIf="movie.filme?.genero || movie.filme?.Genero">{{ movie.filme?.genero || movie.filme?.Genero }}</span>
            <span *ngIf="movie.filme?.duracao || movie.filme?.Duracao"> √Ç¬∑ {{ movie.filme?.duracao || movie.filme?.Duracao }} min</span>
          </div>
          <div class="poster-date" *ngIf="(movie.data || movie.Data)">
            Added: {{ (movie.data || movie.Data) | date:'short' }}
          </div>
        </div>
      </div>
    </div>

    <div class="empty-list-message" *ngIf="filteredCurrentList.length === 0">
      <p>Nenhum filme nesta lista ainda.</p>
    </div>
  </div>
</div>

<!-- APAGAR a Conta -->
<div class="modal-overlay" *ngIf="isDeleting" (click)="closeDeleteConfirm()">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeDeleteConfirm()">&times;</button>

    <h3>Delete account</h3>
    <p class="delete-info">Para apagar a sua conta escreva <strong>delete</strong></p>

    <form (ngSubmit)="confirmDelete()">
      <input id="deleteInput"
             name="deleteInput"
             type="text"
             [(ngModel)]="deleteInput"
             autocomplete="off"
             aria-label="Escreva 'delete' para confirmar" />

      <div class="modal-actions">
        <button type="submit"
                class="danger-btn"
                [disabled]="(deleteInput || '').trim().toLowerCase() !== deleteRequiredText || isDeletingSaving">
          Confirm
        </button>

        <button type="button"
                class="cancel-btn"
                (click)="closeDeleteConfirm()"
                [disabled]="isDeletingSaving">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>
