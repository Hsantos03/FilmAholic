<div class="page">
  <header class="topbar">
    <button class="icon-btn" (click)="openDesafios()" aria-label="Desafios">&#127942;</button>

    <a class="brand" routerLink="/dashboard" aria-label="Go to dashboard">FilmAholic</a>

    <div class="search" #searchContainer>
      <div class="search-pill" role="search">
        <button class="pill-icon left" type="button" aria-label="Opcoes">
          &#9776;
        </button>

        <input type="text"
               [(ngModel)]="searchTerm"
               (ngModelChange)="onSearchChange($event)"
               (focus)="onSearchFocus()"
               (keyup.enter)="doSearch()"
               placeholder="Pesquisar filmes..."
               aria-label="Pesquisar" />

        <button class="pill-icon right" type="button" aria-label="Pesquisar" (click)="doSearch()">
          &#128269;
        </button>
      </div>

      <div class="search-menu" *ngIf="showSearchMenu" role="listbox" aria-label="Sugestões de filmes">
        <div *ngIf="isSuggestionsMode" class="search-menu-title">Sugestões para si</div>
        <div *ngIf="isSuggestionsMode && isLoadingSuggestions" class="search-empty">A carregar sugestões…</div>
        <div *ngIf="isSuggestionsMode && !isLoadingSuggestions && searchResults.length === 0 && hasGenrePreferences" class="search-empty">
          Nenhum filme dos teus géneros apareceu agora — tenta outro título ou mistura de géneros.
        </div>
        <div *ngIf="isSuggestionsMode && !isLoadingSuggestions && searchResults.length === 0 && !hasGenrePreferences" class="search-empty">
          Escolhe os teus géneros favoritos no perfil para desbloquear sugestões só para ti.
        </div>
        <div *ngIf="searchResultsLoading" class="search-empty">
          A pesquisar…
        </div>
        <a class="search-item"
           *ngFor="let m of searchResults"
           href="javascript:void(0)"
           (click)="openSearchResult(m)"
           role="option">
          <img class="search-thumb" [src]="posterOf(m)" [alt]="m.titulo" />
          <div class="search-title">{{ m.titulo }}</div>
        </a>
        <div *ngIf="!isSuggestionsMode && !searchResultsLoading && searchResults.length === 0" class="search-empty">
          Nao foram encontrados resultados para "{{ searchTerm }}"
        </div>
      </div>
    </div>

    <div class="top-actions">
      <button class="icon-btn" aria-label="Favoritos">&#128278;</button>

      <button class="icon-btn" routerLink="/profile" aria-label="Perfil">&#128100;</button>
    </div>
  </header>

  <main class="content">
    <div class="state" *ngIf="isLoadingMovies">A carregar filmes&hellip;</div>
    <div class="state error" *ngIf="!isLoadingMovies && errorMovies">
      {{ errorMovies }}
    </div>

    <section class="strip strip-full" *ngIf="!isLoadingMovies && featured.length">
      <div class="strip-inner">
        <div class="section-head">
          <h2>Em Destaque</h2>
        </div>

        <div class="carousel hero">
          <button class="chevron left"
                  (click)="prevFeatured()"
                  [disabled]="featuredIndex === 0"
                  aria-label="Anterior">
            &lsaquo;
          </button>

          <div class="carousel-track">
            <a class="poster-card hero"
               *ngFor="let f of featuredVisible"
               [routerLink]="['/movie-detail', f.id]">
              <img [src]="posterOf(f)" [alt]="f.titulo" />
            </a>
          </div>

          <button class="chevron right"
                  (click)="nextFeatured()"
                  [disabled]="featuredIndex >= (featured.length - featuredVisibleCount)"
                  aria-label="Seguinte">
            &rsaquo;
          </button>
        </div>
      </div>
    </section>

    <section class="strip strip-full top10-strip" *ngIf="!isLoadingMovies && top10.length">
      <div class="strip-inner">
        <div class="section-head">
          <h2>Top 10 filmes</h2>
        </div>

        <div class="carousel top10">
          <button class="chevron left"
                  (click)="prevTop10()"
                  [disabled]="top10Index === 0"
                  aria-label="Anterior">
            &lsaquo;
          </button>

          <div class="carousel-track">
            <a class="poster-card small"
               *ngFor="let f of top10Visible"
               [routerLink]="['/movie-detail', f.id]">
              <img [src]="posterOf(f)" [alt]="f.titulo" />
            </a>
          </div>

          <button class="chevron right"
                  (click)="nextTop10()"
                  [disabled]="top10Index >= (top10.length - top10VisibleCount)"
                  aria-label="Seguinte">
            &rsaquo;
          </button>
        </div>
      </div>
    </section>

    <section class="strip strip-full desafios-strip">
      <div class="strip-inner">
        <div class="section-head">
          <h2>Desafios Semanais</h2>
        </div>
        <div class="desafios-dashboard-cards">
          <button class="desafio-card-btn" (click)="openDesafios()" type="button">
            <span class="desafio-card-icon">&#127942;</span>
            <span class="desafio-card-label">Ver desafios</span>
            <span class="desafio-card-desc">Completa desafios e ganha XP</span>
          </button>
        </div>
      </div>
    </section>

    <section class="strip strip-full nextup-strip">
      <div class="strip-inner">
        <div class="section-head">
          <h2>O que vou ver a seguir</h2>
        </div>

        <div class="discover-wrap">
          <button class="discover-btn" (click)="discoverNext()" [disabled]="isDiscovering || isLoadingMovies">
            {{ isDiscovering ? 'A descobrir…' : 'Descobrir' }}
          </button>
        </div>

        <div class="nextup-content">
          <div *ngIf="!isLoadingMovies && movies.length === 0" class="empty-list-message">
            A lista está em branco como um ecrã antes da sessão. Procura ou escolhe géneros para começar o espetáculo.
          </div>

          <div class="nextup-card" *ngIf="nextToWatch">
            <a [routerLink]="['/movie-detail', nextToWatch.id]">
              <img class="nextup-poster" [src]="posterOf(nextToWatch)" [alt]="nextToWatch.titulo" />
            </a>

            <div class="nextup-meta">
              <h3 class="nextup-title">{{ nextToWatch.titulo }}</h3>
              <div class="nextup-sub">{{ nextToWatch.genero }} &middot; {{ nextToWatch.duracao | formatDuration }}</div>
              <div class="nextup-actions">
                <button class="action-btn" (click)="goToMovieDetail(nextToWatch.id)">Ver detalhes</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="state" *ngIf="isLoadingActors">A carregar atores&hellip;</div>
    <div class="state error" *ngIf="!isLoadingActors && errorActors">
      {{ errorActors }}
    </div>

    <section class="strip strip-full" *ngIf="!isLoadingActors && atores.length">
      <div class="strip-inner">
        <div class="section-head">
          <h2>Top 10 atores</h2>
        </div>

        <div class="carousel top10">
          <button class="chevron left"
                  (click)="prevAtores()"
                  [disabled]="atoresIndex === 0"
                  aria-label="Anterior">
            &lsaquo;
          </button>

          <div class="carousel-track">
            <div class="actor-card" *ngFor="let a of atoresVisible">
              <img class="actor-photo" [src]="fotoAtor(a)" [alt]="a.nome" />
              <div class="actor-name">{{ a.nome }}</div>
            </div>
          </div>

          <button class="chevron right"
                  (click)="nextAtores()"
                  [disabled]="atoresIndex >= (atores.length - atoresVisibleCount)"
                  aria-label="Seguinte">
            &rsaquo;
          </button>
        </div>
      </div>
    </section>
  </main>
</div>

<div class="modal-overlay" *ngIf="isDesafiosOpen" (click)="closeDesafios()">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeDesafios()">&times;</button>

    <h3>Desafios Semanais</h3>

    <div *ngIf="isLoadingDesafios" class="modal-loading">Loading desafios...</div>

    <div class="desafios-list" *ngIf="!isLoadingDesafios">
      <div class="desafio-row" *ngFor="let d of desafios" [class.completed]="isCompleted(d)">
        <div class="desafio-meta">
          <h4 class="desafio-title">{{ d.descricao }}</h4>

          <div class="desafio-sub">
            {{ d.genero }} &middot; {{ d.dataInicio | date:'shortDate' }} - {{ d.dataFim | date:'shortDate' }}
          </div>
        </div>

        <div class="desafio-progress">
          <div class="progress-text">
            <span *ngIf="!isCompleted(d)">
              {{ d.progresso }} / {{ d.quantidadeNecessaria }}
            </span>

            <span *ngIf="isCompleted(d)" aria-live="polite">&#10003; Completed</span>
          </div>

          <div class="progress-bar" aria-hidden="true">
            <div class="progress-fill"
                 [style.width.%]="computeProgressPercent(d.progresso, d.quantidadeNecessaria)"></div>
          </div>

          <div class="xp-badge">+{{ d.xp }} XP</div>
        </div>
      </div>

      <div *ngIf="desafios.length === 0" class="empty-list-message">
        Nenhum desafio disponivel.
      </div>
    </div>

    <div class="modal-actions">
      <button class="save-btn" (click)="closeDesafios()">Close</button>
    </div>
  </div>
</div>
