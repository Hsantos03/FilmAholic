<header class="topbar">
  <button class="icon-btn" (click)="goBack()" aria-label="Back">&larr;</button>
  <a class="brand" routerLink="/dashboard">FilmAholic</a>
</header>

<main class="content">
  <div *ngIf="isLoading" class="state">A carregar filme‚Ä¶</div>
  <div *ngIf="error" class="state error">{{ error }}</div>

  <div *ngIf="filme as f" class="movie-page-inner">
    <div class="movie-card">

      <!--  CAPA -->
      <aside class="poster-col">
        <img class="movie-poster" [src]="posterOf()" [alt]="f.titulo" />

        <div class="hours" *ngIf="totalHours">
          Total de horas vistas: {{ totalHours | number:'1.1-2' }}h
        </div>
      </aside>

      <!-- INFO -->
      <section class="info-col centered">

        <!-- T√çTULO -->
        <h1 class="movie-title">{{ f.titulo }}</h1>
        <div class="movie-sub">
          {{ f.ano ? f.ano + ' ¬∑ ' : '' }}{{ f.genero }} ¬∑ {{ f.duracao | formatDuration }}
        </div>

        <!-- A√á√ïES -->
        <div class="actions-row">
          <button class="btn ghost"
                  [class.active]="inWatchLater"
                  (click)="addQueroVer()"
                  title="Adicionar √† lista Quero Ver">
            Quero Ver
          </button>

          <button class="btn primary"
                  [class.active]="inWatched"
                  (click)="addJaVi()"
                  title="Marcar como j√° visto">
            J√° Vi
          </button>

          <button class="btn danger"
                  *ngIf="inWatchLater || inWatched"
                  (click)="remove()"
                  title="Remover das minhas listas (Quero Ver / J√° Vi)">
            Remover
          </button>

          <button class="btn favorite"
                  [class.active]="isFavorite"
                  (click)="toggleFavorite()"
                  title="Adicionar ou remover dos favoritos">
            &#9733; Favorito
          </button>
        </div>

        <!-- RATINGS (APIs) -->
        <div class="ratings-block">
          <div class="ratings-title">Ratings</div>

          <div *ngIf="isLoadingRatings" class="ratings-loading">
            A carregar ratings‚Ä¶
          </div>

          <div *ngIf="!isLoadingRatings && ratings" class="ratings-grid">
            <div class="rating-item">
              <div class="rating-label">
                <img class="rating-logo"
                     src="https://www.themoviedb.org/assets/2/v4/logos/v2/blue_square_2-d537fb228cf3ded904ef09b136fe3fec72548ebc1fea3fbbd1ad9e36364db38b.svg"
                     alt="TMDb"
                     title="The Movie Database" />
              </div>
              <div class="rating-value">
                {{ ratings.tmdbVoteAverage | number:'1.1-1' }}/10
                <span class="rating-sub">({{ ratings.tmdbVoteCount }} votos)</span>
              </div>
            </div>

            <div class="rating-item">
              <div class="rating-label">
                <img class="rating-logo"
                     src="https://upload.wikimedia.org/wikipedia/commons/6/69/IMDB_Logo_2016.svg"
                     alt="IMDb"
                     title="Internet Movie Database" />
              </div>
              <div class="rating-value">{{ ratings.imdbRating || '‚Äî' }}/10</div>
            </div>

            <div class="rating-item">
              <div class="rating-label">
                <img class="rating-logo"
                     src="https://upload.wikimedia.org/wikipedia/commons/2/20/Metacritic.svg"
                     alt="Metacritic"
                     title="Metacritic" />
              </div>
              <div class="rating-value">{{ ratings.metascore || '‚Äî' }}/100</div>
            </div>

            <div class="rating-item">
              <div class="rating-label">
                <img class="rating-logo"
                     src="https://upload.wikimedia.org/wikipedia/commons/5/5b/Rotten_Tomatoes.svg"
                     alt="Rotten Tomatoes"
                     title="Rotten Tomatoes" />
              </div>
              <div class="rating-value">{{ ratings.rottenTomatoes || '‚Äî' }}</div>
            </div>
          </div>
        </div>

        <!-- FILMAHOLIC RATING -->
        <div class="our-rating-block">
          <div class="our-rating-head">
            <div class="our-rating-title">Classifica√ß√£o FilmAholic</div>

            <div class="our-rating-summary">
              <span class="our-rating-avg">{{ ourAverage | number:'1.1-1' }}/10</span>
              <span class="our-rating-count">({{ ourCount }} votos)</span>
            </div>
          </div>

          <div class="our-rating-row" (mouseleave)="clearMovieStarHover()">
            <div class="our-stars" [class.disabled]="!canRateMovie || isSavingMovieRating">
              <button class="our-star-btn"
                      type="button"
                      *ngFor="let i of [1,2,3,4,5]"
                      (mousemove)="onMovieStarHover(i, $event)"
                      (click)="setMovieRating(i, $event)"
                      [disabled]="!canRateMovie || isSavingMovieRating"
                      aria-label="Avaliar">
                <span class="our-star-visual"
                      [class.full]="isStarFull(i)"
                      [class.half]="isStarHalf(i)">‚òÖ</span>
              </button>
            </div>

            <div class="our-rating-me">
              <span *ngIf="myScore !== null">A tua nota: <strong>{{ myScore }}/10</strong></span>
              <span *ngIf="myScore === null" class="muted">Ainda n√£o avaliaste</span>
            </div>
          </div>

          <div class="our-rating-actions">
            <button class="btn ghost"
                    type="button"
                    *ngIf="canRateMovie && myScore !== null"
                    (click)="clearMyMovieRating()"
                    [disabled]="isSavingMovieRating">
              Remover avalia√ß√£o
            </button>

            <span class="muted" *ngIf="!canRateMovie">Faz login para avaliar.</span>
          </div>

          <div class="state error" *ngIf="ratingError">{{ ratingError }}</div>
        </div>

        <!-- SINOPSE -->
        <div class="overview" *ngIf="overview">
          <h3>Sinopse</h3>
          <p>{{ overview }}</p>
        </div>

        <!-- COMMENTS -->
        <div class="comments">
          <h3>Coment√°rios</h3>

          <!-- WRITE COMMENT -->
          <div class="comment-row">
            <div class="comment-box">
              <div class="avatar avatar-sm" title="Tu">
                <img *ngIf="userFotoPerfilUrl" class="avatar-img" [src]="userFotoPerfilUrl" [alt]="userName" />
                <span *ngIf="!userFotoPerfilUrl">{{ userName.charAt(0) }}</span>
              </div>

              <input class="comment-input"
                     type="text"
                     placeholder="Escreve um coment√°rio‚Ä¶"
                     [(ngModel)]="newComment"
                     [disabled]="isSendingComment" />

              <button class="send-btn"
                      type="button"
                      (click)="sendComment()"
                      [disabled]="isSendingComment"
                      aria-label="Enviar coment√°rio">
                ‚û§
              </button>
            </div>
          </div>

          <div class="state error" *ngIf="commentError">
            {{ commentError }}
          </div>

          <!-- LISTA DE COMENT√ÅRIOS -->
          <div class="comments-list" *ngIf="comments?.length; else noComments">
            <div class="comment-item" *ngFor="let c of comments">

              <div class="avatar avatar-md">
                <img *ngIf="c.fotoPerfilUrl" class="avatar-img" [src]="c.fotoPerfilUrl" [alt]="c.userName" />
                <span *ngIf="!c.fotoPerfilUrl">{{ c.userName && c.userName.length ? c.userName.charAt(0) : 'U' }}</span>
              </div>

              <div class="comment-content">
                <div class="comment-header">
                  <strong class="comment-user">{{ c.userName }}</strong>

                  <!-- A√á√ïES + VOTOS (fora do modo edi√ß√£o) -->
                  <div class="comment-actions" *ngIf="editingCommentId !== c.id">
                    <button type="button"
                            class="comment-btn"
                            [class.active]="c.myVote === 1"
                            (click)="voteComment(c, 1)"
                            title="Like">
                      üëç {{ c.likeCount || 0 }}
                    </button>

                    <button type="button"
                            class="comment-btn"
                            [class.active]="c.myVote === -1"
                            (click)="voteComment(c, -1)"
                            title="Dislike">
                      üëé {{ c.dislikeCount || 0 }}
                    </button>

                    <button type="button"
                            class="comment-btn"
                            *ngIf="c.canEdit"
                            (click)="startEdit(c)">
                      Editar
                    </button>

                    <button type="button"
                            class="comment-btn danger"
                            *ngIf="c.canEdit"
                            (click)="deleteComment(c)"
                            [disabled]="isDeletingComment">
                      Apagar
                    </button>
                  </div>
                </div>

                <!-- Modo edi√ß√£o -->
                <div class="comment-edit-form" *ngIf="editingCommentId === c.id">
                  <textarea class="comment-edit-input"
                            [(ngModel)]="editText"
                            rows="3"
                            [disabled]="isSavingEdit"></textarea>

                  <div class="comment-edit-actions">
                    <button type="button"
                            class="btn primary"
                            (click)="saveEdit()"
                            [disabled]="isSavingEdit">
                      Guardar
                    </button>

                    <button type="button"
                            class="btn ghost"
                            (click)="cancelEdit()"
                            [disabled]="isSavingEdit">
                      Cancelar
                    </button>
                  </div>
                </div>

                <p class="comment-text" *ngIf="editingCommentId !== c.id">{{ c.texto }}</p>

                <div class="comment-meta" *ngIf="editingCommentId !== c.id">
                  <span>{{ c.dataCriacao | date:'short' }}</span>
                </div>
              </div>
            </div>
          </div>

          <ng-template #noComments>
            <div class="comments-empty">Ainda n√£o existem coment√°rios.</div>
          </ng-template>
        </div>

      </section>
    </div>

    <!-- RELACIONADOS / RECOMENDA√á√ïES -->
    <section class="recommendations-section" *ngIf="!isLoadingRecommendations && recommendations.length">
      <div class="section-head">
        <h2>Relacionados</h2>
      </div>

      <div class="recommendations-grid">
        <div class="rec-card"
             *ngFor="let r of recommendations"
             (click)="goToRecommendation(r)"
             style="cursor: pointer;">
          <img class="rec-poster" [src]="recommendationPoster(r)" [alt]="r.titulo" />
        </div>
      </div>
    </section>

    <div class="state" *ngIf="isLoadingRecommendations">A carregar recomenda√ß√µes...</div>
  </div>
</main>
